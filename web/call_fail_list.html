<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>联合数据电话销售系统</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- basic styles -->

    <!-----Add page stylesheet---lzr-->
    <link rel="stylesheet" href="assets/css/page-detail.css">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="assets/css/font-awesome.min.css"/>

    <!--[if IE 7]>
    <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css"/>
    <![endif]-->

    <!-- page specific plugin styles -->
    <script src="assets/js/jquery-2.0.3.min.js"></script>
    <script src="assets/bootstrap-table.js"></script>

    <link rel="stylesheet" href="assets/css/jquery-ui-1.10.3.custom.min.css"/>
    <link rel="stylesheet" href="assets/css/chosen.css"/>
    <link rel="stylesheet" href="assets/css/datepicker.css"/>
    <link rel="stylesheet" href="assets/css/bootstrap-timepicker.css"/>
    <link rel="stylesheet" href="assets/css/daterangepicker.css"/>
    <link rel="stylesheet" href="assets/css/colorpicker.css"/>
    <link rel="stylesheet" href="assets/bootstrap-table.css"/>

    <!-- fonts -->

    <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:400,300"/>-->

    <!-- ace styles -->

    <link rel="stylesheet" href="assets/css/ace.min.css"/>
    <link rel="stylesheet" href="assets/css/ace-rtl.min.css"/>
    <link rel="stylesheet" href="assets/css/ace-skins.min.css"/>

    <!--[if lte IE 8]>
    <link rel="stylesheet" href="assets/css/ace-ie.min.css"/>
    <![endif]-->
    <!-- basic scripts -->

    <!--[if !IE]> -->

    <script src="assets/js/jquery-2.0.3.min.js"></script>

    <!-- <![endif]-->

    <!--[if IE]>
    <script src="assets/js/jquery-1.10.2.min.js"></script>
    <![endif]-->

    <!--[if !IE]> -->

    <script type="text/javascript">
        window.jQuery || document.write("<script src='assets/js/jquery-2.0.3.min.js'>" + "<" + "/script>");
    </script>

    <!-- <![endif]-->

    <!--[if IE]>
    <script type="text/javascript">
        window.jQuery || document.write("<script src='assets/js/jquery-1.10.2.min.js'>" + "<" + "/script>");
    </script>
    <![endif]-->

    <script type="text/javascript">
        if ("ontouchend" in document) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>" + "<" + "/script>");
    </script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/typeahead-bs2.min.js"></script>

    <!-- page specific plugin scripts -->

    <!--[if lte IE 8]>
    <script src="assets/js/excanvas.min.js"></script>
    <![endif]-->

    <!-- inline styles related to this page -->

    <!-- ace settings handler -->

    <script src="assets/js/ace-extra.min.js"></script>
    <script src="assets/bootstrap-table.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->

    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="navbar navbar-default" id="navbar">
    <script type="text/javascript">
        try {
            ace.settings.check('navbar', 'fixed')
        } catch (e) {
        }
    </script>

    <div class="navbar-container" id="navbar-container">
        <div class="navbar-header pull-left">
            <a href="#" class="navbar-brand">
                <small>
                    <i class="icon-leaf"></i>
                    联合数据电话销售系统
                </small>
            </a><!-- /.brand -->
        </div><!-- /.navbar-header -->

        <div class="navbar-header pull-right" role="navigation">
            <ul class="nav ace-nav">
                <li class="light-blue">
                    <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                        <img class="nav-user-photo" src="assets/avatars/user.jpg" alt="Jason's Photo"/>
                        <span class="user-info">
									<small>Welcome,</small>
									Jason
								</span>

                        <i class="icon-caret-down"></i>
                    </a>

                    <ul class="user-menu pull-right dropdown-menu dropdown-yellow dropdown-caret dropdown-close">
                        <li>
                            <a href="#">
                                <i class="icon-cog"></i>
                                Settings
                            </a>
                        </li>

                        <li>
                            <a href="#">
                                <i class="icon-user"></i>
                                Profile
                            </a>
                        </li>

                        <li class="divider"></li>

                        <li>
                            <a href="/logout">
                                <i class="icon-off"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul><!-- /.ace-nav -->
        </div><!-- /.navbar-header -->
    </div><!-- /.container -->
</div>

<div class="main-container" id="main-container">
    <script type="text/javascript">
        try {
            ace.settings.check('main-container', 'fixed')
        } catch (e) {
        }
    </script>

    <div class="main-container-inner">
        <a class="menu-toggler" id="menu-toggler" href="#">
            <span class="menu-text"></span>
        </a>

        <div class="sidebar" id="sidebar">
            <script type="text/javascript">
                try {
                    ace.settings.check('sidebar', 'fixed')
                } catch (e) {
                }
            </script>


            <ul class="nav nav-list">
                <li class="active">
                    <a href="#">
                        <i class="icon-dashboard"></i>
                        <span class="menu-text"> 控制台 </span>
                    </a>
                </li>

                <li class="active open">
                    <a href="#" class="dropdown-toggle">
                        <i class="icon-edit"></i>
                        <span class="menu-text"> 待沟通客户 </span>

                        <b class="arrow icon-angle-down"></b>
                    </a>

                    <ul class="submenu">
                        <li class="active">
                            <a href="form-elements.html">
                                <i class="icon-double-angle-right"></i>
                                待沟通客户信息
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="active open">
                    <a href="#" class="dropdown-toggle">
                        <i class="icon-edit"></i>
                        <span class="menu-text"> 待跟进客户清单 </span>

                        <b class="arrow icon-angle-down"></b>
                    </a>

                    <ul class="submenu">
                        <li class="active">
                            <a href="call_fail_list.html">
                                <i class="icon-double-angle-right"></i>
                                电话未打通的客户
                            </a>
                        </li>
                        <li class="active">
                            <a href="no_answer_list.html">
                                <i class="icon-double-angle-right"></i>
                                电话无人接听的客户
                            </a>
                        </li>
                        <li class="active">
                            <a href="unexpired_insurance_list.html">
                                <i class="icon-double-angle-right"></i>
                                保险未到期的客户
                            </a>
                        </li>
                    </ul>

                </li>


            </ul><!-- /.nav-list -->

            <div class="sidebar-collapse" id="sidebar-collapse">
                <i class="icon-double-angle-left" data-icon1="icon-double-angle-left"
                   data-icon2="icon-double-angle-right"></i>
            </div>

            <script type="text/javascript">
                try {
                    ace.settings.check('sidebar', 'collapsed')
                } catch (e) {
                }
            </script>
        </div>

        <div class="main-content">
            <div class="breadcrumbs" id="breadcrumbs">
                <script type="text/javascript">
                    try {
                        ace.settings.check('breadcrumbs', 'fixed')
                    } catch (e) {
                    }
                </script>

                <ul class="breadcrumb">
                    <li>
                        <i class="icon-home home-icon"></i>
                        <a href="#">主页</a>
                    </li>

                    <li>
                        <a href="#">电话未打通的客户</a>
                    </li>
                    <li class="active">电话未打通的客户名单</li>
                </ul><!-- .breadcrumb -->

            </div>

            <div class="page-content">
                <div class="page-header">
                    <h1>
                        电话未打通的客户
                        <small>
                            <i class="icon-double-angle-right"></i>
                            电话未打通的客户名单
                        </small>
                    </h1>
                </div><!-- /.page-header -->

                <div class="row">

                    <div class="col-xs-12 col-sm-4">
                        <div id="table0">
                            <table id="sample-table-0"></table>
                        </div>
                        <hr/>
                        <div class="col-md-offset-3">
                            &nbsp; &nbsp; &nbsp;
                            <button class="btn btn-info" type="button">
                                <i class="icon-ok bigger-110"></i>
                                拨打电话
                            </button>

                            &nbsp; &nbsp; &nbsp;
                        </div>
                    </div>

                    <div class="col-xs-12 col-sm-4">
                        <!-- PAGE CONTENT BEGINS -->

                        <form class="form-horizontal" role="form" id="form1">

                            <!--<div class="space-4"></div>-->

                            <!--<div class="hr hr-24"></div>-->

                            <div class="widget-box">
                                <div class="widget-header">
                                    <h4>反馈记录</h4>
                                </div>
                                <div class="widget-body">
                                    <div class="widget-main">
                                        <div class="control-group">
                                            <label class="control-label bolder blue">是否成功</label>

                                            <div class="radio">
                                                <div class="space-1">
                                                    <label>
                                                        <input name="status" type="radio"
                                                               class="ace" value="one"/>
                                                        <span class="lbl">是</span>
                                                    </label>
                                                </div>
                                                <div class="space-1">
                                                    <label>
                                                        <input name="status" type="radio"
                                                               class="ace" value="two"/>
                                                        <span class="lbl">待跟进</span>
                                                    </label>
                                                </div>
                                                <div class="space-1">
                                                    <label>
                                                        <input name="status" type="radio"
                                                               class="ace" value="three"/>
                                                        <span class="lbl">否</span>
                                                    </label>
                                                </div>

                                            </div>
                                            <hr/>
                                            <div>
                                                <label for="failReason">推销失败原因</label>

                                                <select class="form-control" id="failReason" name="failReason">
                                                    <!--Add attribute name, Corresponds to the fields 'fail_reason_type' in the database-->
                                                    <!--<option value="">&nbsp;</option>-->
                                                    <option value="未打通">未打通</option>
                                                    <option value="无人接听">无人接听</option>
                                                    <option value="空号">空号</option>
                                                    <option value="客户直接挂电话">客户直接挂电话</option>
                                                    <option value="保险未到期">保险未到期</option>
                                                    <option value="客户不需要保险">客户不需要保险</option>
                                                    <option value="其他">其他</option>


                                                </select>
                                            </div>
                                            <hr/>
                                            <label for="lastdate">上次车险购买时间</label>

                                            <div class="row">
                                                <div class="col-xs-8 col-sm-11">
                                                    <div class="input-group">
                                                        <input class="form-control date-picker"
                                                               name="lastdate"
                                                               id="lastdate" type="text"
                                                               data-date-format="yyyy-mm-dd"/>
                                                        <span class="input-group-addon">
																		<i class="icon-calendar bigger-110"></i>
																	</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr/>
                                            <div>
                                                <label for="remark">备注</label>

                                                <textarea id="remark"
                                                          class="autosize-transition form-control"
                                                          name="remark"></textarea>
                                            </div>
                                            <hr/>
                                            <div class="col-md-offset-2">
                                                <button class="btn btn-info" id="submitBtn" type="button" value="submit"
                                                        onclick="fsubmit()">
                                                    <i class="icon-ok bigger-110"></i>
                                                    下一个
                                                </button>

                                                &nbsp; &nbsp; &nbsp;
                                                <button class="btn" type="button">
                                                    <i class="icon-undo bigger-110"></i>
                                                    取消
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div><!-- /span -->
                        </form>

                        <script type="text/javascript">
                            function fsubmit() {
                                //---Post current customer feedback info---lzr
                                $.ajax({
                                    url: "/updateFeedback",
                                    method: 'POST',
                                    dataType: 'json',
                                    data: {
                                        customerId: $('.card-view')[0].lastChild.innerHTML,
                                        lastPurchasedate: $('form').find('#lastdate').val(),
                                        remark: $('form').find('#remark').val(),
                                        failReasonType: $('form').find('#failReason').val(),
                                        status: $('form').find("input[type='radio']:checked").val()
                                    },
                                    success: function (resp) {

                                        if (resp.message == 'success') {
//                                            window.location.href = 'dashboard-1.html';
                                            //清空表单
                                            $('#form1')[0].reset();
                                            var tabledata = $('#sample-table-1').bootstrapTable('getData');
//                                            console.log(tabledata);
                                            var tableindex;
                                            //先获取id再清空表格
                                            var customerId=$('.card-view')[0].lastChild.innerHTML;
                                            $('#table0').empty();

                                            var nextcustomerid;
                                            var box = document.getElementById("table0");
                                            var table0 = document.createElement("table");
                                            table0.setAttribute("id", "sample-table-0");
                                            box.appendChild(table0);
                                            for(var i=0;i<tabledata.length;i++){
                                                    if(customerId==tabledata[i].customerId){
                                                        tableindex=i+1;
                                                        if (tableindex<tabledata.length){
                                                            nextcustomerid=tabledata[i+1].customerId;
                                                        }
                                                    }
                                             }

                                            if(tableindex<tabledata.length){
//                                                console.log(tabledata.length);
//                                                console.log(tableindex);
                                                $('#sample-table-0').bootstrapTable({
                                                    url: '/getOneCustomer?id=' + nextcustomerid,
                                                    columns: [{
                                                        field: 'customerId',
                                                        title: '客户ID'
                                                    }, {
                                                        field: 'customerPhone',
                                                        title: '电话号码'
                                                    }, {
                                                        field: 'gender',
                                                        title: '性别'
                                                    }, {
                                                        field: 'age',
                                                        title: '年龄'
                                                    }, {
                                                        field: 'model',
                                                        title: '车型'
                                                    }, {
                                                        field: 'value',
                                                        title: '客户价值'
                                                    }, {
                                                        field: 'status',
                                                        title: '状态'
                                                    }]
                                                });
                                                $('#sample-table-0').bootstrapTable('toggleView');
                                            }else {
                                                alert("已经是最后一个了")
                                            }
                                        }

                                        // Show errors
                                        if (resp.message == 'error') {

                                        }
                                    }
                                });

                                //---Get next customer info, highlight next row
                                //---Get current customerId---lzr
                                var currentCustomerId = $('.card-view')[0].lastChild.innerHTML;
                                //---Check whether has next row
                                var tableData = $('#sample-table-1').bootstrapTable('getData');
                                var lastCustomerId = tableData[tableData.length-1].customerId
                                var hasNext = currentCustomerId+1 == lastCustomerId ? false : true;
                                generateFeedbackInfoTable(currentCustomerId+1, hasNext);
                                //---Highlight customer status list---lzr
                                if(hasNext){
                                    //获取当前页最后一行数据的customerId
                                    var curPageLastCustomerId = $("#sample-table-1").lastChild("tr").find("td").eq(0);
                                    //下一个数据跨页
                                    if(currentCustomerId == curPageLastCustomerId){
                                        //先翻页，自动高亮
                                        $(".col-xs-12 .page-next a").click();
                                    }
                                    //如果不跨页，则高亮下一行
                                    else{
                                        var currentTableIndex = $("#sample-table-1").parent().attr("data-index");
                                        $("#sample-table-1 tr td").removeAttr("id");
                                        $("#sample-table-1").find("tr[data-index ="+ currentTableIndex+1 +"] td").attr("id","table-row-highlight");
                                    }
                                }

                                //---Update customer info table---lzr
                                $('#table0').empty();
                                var box = document.getElementById("table0");
                                var table0 = document.createElement("table");
                                table0.setAttribute("id", "sample-table-0");
                                box.appendChild(table0);
                                //---Call the generateCustomerInfoTable(id) function---lzr
                                generateCustomerInfoTable(currentCustomerId+1);

                            }
                        </script>

                        <div class="hr hr-18 dotted hr-double"></div>

                    </div>

                    <div class="col-xs-12 col-sm-2" style="width:28%;">
                        <table id="sample-table-1"></table>
                        <script type="text/javascript">
                            $('#sample-table-1').bootstrapTable({
                                url: '/getAllCustomerList',
                                pagination: true,           //---Add pagination---lzr
                                pageSize: 10,
                                classes: 'table table-striped table-bordered table-hover',
                                columns: [{
                                    field: 'customerId',
                                    title: '客户ID',
                                    width: '64%'
                                }, {
                                    field: 'status',
                                    title: '状态',
                                    width: '64%'
                                }],
                                onClickRow: function (row, element) {   //---Add parameters 'element', represents tr element---lzr
                                    $('#table0').empty();
                                    var box = document.getElementById("table0");
                                    var table0 = document.createElement("table");
                                    table0.setAttribute("id", "sample-table-0");
                                    box.appendChild(table0);

                                    //---HighLight active row---lzr
                                    $("#sample-table-1 tr td").removeAttr("id");
                                    $(element).children("td").attr("id","table-row-highlight");

                                    //---Call the generateCustomerInfoTable(id) function---lzr
                                    generateCustomerInfoTable(row.customerId);

                                    //---Check whether has next row
                                    var tableData = $('#sample-table-1').bootstrapTable('getData');
                                    var lastCustomerId = tableData[tableData.length-1].customerId
                                    var hasNext = row.customerId == lastCustomerId ? false : true;
                                    generateFeedbackInfoTable(row.customerId, hasNext);
                                },
                                onLoadSuccess: function () {
                                    //用获取table(通过其id ) 获取指定的行，列
                                    var id = document.getElementById("sample-table-1").rows[1].cells[0].innerHTML;

                                    //---Highlight first row---lzr
                                    $("#sample-table-1 tr[data-index='0'] td").attr("id","table-row-highlight");

                                    console.log(id + "------");

                                    //---Call the generateCustomerInfoTable(id) function---lzr
                                    generateCustomerInfoTable(id);
                                },
                                onPageChange: function(number){     //---Fires when change page number---lzr
                                    //---Hightlight the first row of table---lzr
                                    $("#sample-table-1").find("tr").eq(1).children("td").attr("id","table-row-highlight");

                                    //---Refresh #sample-table-0 contents
                                    $('#table0').empty();
                                    var box = document.getElementById("table0");
                                    var table0 = document.createElement("table");
                                    table0.setAttribute("id", "sample-table-0");
                                    box.appendChild(table0);

                                    //用获取table(通过其id ) 获取指定的行，列
                                    var id = document.getElementById("sample-table-1").rows[1].cells[0].innerHTML;

                                    //---Call the generateCustomerInfoTable(id) function---lzr
                                    generateCustomerInfoTable(id);
                                }
                            });

                            //---Generate customer info table---lzr
                            function generateCustomerInfoTable(id) {
                                $('#sample-table-0').bootstrapTable({
                                    url: '/getOneCustomer?id=' + id,
                                    columns: [{
                                        field: 'customerId',
                                        title: '客户ID'
                                    }, {
                                        field: 'customerPhone',
                                        title: '电话号码'
                                    }, {
                                        field: 'gender',
                                        title: '性别'
                                    }, {
                                        field: 'age',
                                        title: '年龄'
                                    }, {
                                        field: 'model',
                                        title: '车型'
                                    }, {
                                        field: 'value',
                                        title: '客户价值'
                                    }, {
                                        field: 'status',
                                        title: '状态'
                                    }]
                                });
                                $('#sample-table-0').bootstrapTable('toggleView');
                            }

                            //---Generate feedback info---lzr
                            function generateFeedbackInfoTable(id, hasNext){
                                //---Ajax get feedback info---lzr
                                $.ajax({
                                    url: "/getFeedbackByCustomerId?id=" + id ,    //---Change this url---lzr
                                    method: 'GET',
                                    dataType: 'json',
                                    success: function (feedbackJason) {
                                        //清空表单
                                        $('#form1')[0].reset();

                                        var json = eval(feedbackJason);//---Object List---lzr
                                        //---Set form values---lzr
                                        if(json.status == 1){    //---Customer agrees to purchase insurance---lzr
                                            //---Check the radio button---lzr
                                            $(".radio input[value='one']").attr("checked","checked");
                                            //---Fill in the remark box---lzr
                                            $("#remark").text(json.remark);
                                        }
                                        else if(json.status == 2){
                                            //---Check the radio button---lzr
                                            $(".radio input[value='two']").attr("checked","checked");
                                            //---Check the failure reason---lzr
                                            $("#failReason").find("option[name= "+ json.fail_reason_type + "]").attr("selected", true);
                                            //---Check last_purchasedate---lzr
                                            $("#lastdate").val(json.lastPurchasedate);
                                            //---Fill in the remark box---lzr
                                            $("#remark").text(json.remark);
                                        }else if(json.status == 3){
                                            //---Check the radio button---lzr
                                            $(".radio input[value='three']").attr("checked","checked");
                                            //---Check the failure reason---lzr
                                            $("#failReason").find("option[name= "+ json.fail_reason_type + "]").attr("selected", true);
                                            //---Check last_purchasedate---lzr
                                            $("#lastdate").val(json.last_purchasedate);
                                            //---Fill in the remark box---lzr
                                            $("#remark").text(json.remark);
                                        }
                                        //---Check whether the last line of data---lzr
                                        var submitBtn = $("#submitBtn");
                                        if(!hasNext){
                                            //---Disable the button
                                            $("#submitBtn").attr("disabled","disabled");
                                            //---hover
                                            $("#submitBtn").hover(function(){
                                                $(this).popover({
                                                    title: "提示",
                                                    content: "当前已是最后一个用户",
                                                    placement: 'top'
                                                })
                                            })

                                        }else{
                                            $("#submitBtn").removeAttr("disable");
                                            $("#submitBtn").unbind("hover");
                                        }

                                    }
                                });
                            }


                            $(document).ready(function () {

                            });
                            //                            var td1 = document.getElementById("sample-table-1").innerHTML;


                        </script>
                    </div>
                </div><!-- /.row -->


            </div>
        </div><!-- /.main-content -->


    </div>
</div><!-- /#ace-settings-container -->
</div><!-- /.main-container-inner -->

<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
    <i class="icon-double-angle-up icon-only bigger-110"></i>
</a>
</div><!-- /.main-container -->


<script src="assets/js/jquery-ui-1.10.3.custom.min.js"></script>
<script src="assets/js/jquery.ui.touch-punch.min.js"></script>
<script src="assets/js/chosen.jquery.min.js"></script>
<!--<script src="assets/js/fuelux/fuelux.spinner.min.js"></script>-->
<script src="assets/js/date-time/bootstrap-datepicker.min.js"></script>
<script src="assets/js/date-time/bootstrap-timepicker.min.js"></script>
<script src="assets/js/date-time/moment.min.js"></script>
<script src="assets/js/date-time/daterangepicker.min.js"></script>
<script src="assets/js/bootstrap-colorpicker.min.js"></script>
<script src="assets/js/jquery.knob.min.js"></script>
<script src="assets/js/jquery.autosize.min.js"></script>
<script src="assets/js/jquery.inputlimiter.1.3.1.min.js"></script>
<script src="assets/js/jquery.maskedinput.min.js"></script>
<script src="assets/js/bootstrap-tag.min.js"></script>

<!-- ace scripts -->

<script src="assets/js/ace-elements.min.js"></script>
<script src="assets/js/ace.min.js"></script>
</body>
</html>
